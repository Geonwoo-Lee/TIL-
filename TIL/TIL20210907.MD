# TIL 2021 - 09 - 06 ğŸ“– !

- sprint
   - jwt ì¸ì¦ ìˆœì„œ
     1. ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ì„ í•œë‹¤.

     2. ì„œë²„ì—ì„œëŠ” ê³„ì •ì •ë³´ë¥¼ ì½ì–´ ì‚¬ìš©ìë¥¼ í™•ì¸ í›„, ì‚¬ìš©ìì˜ ê³ ìœ í•œ IDê°’ì„ ë¶€ì—¬í•œ í›„, ê¸°íƒ€ ì •ë³´ì™€ í•¨ê»˜ Payloadì— ë„£ìŠµë‹ˆë‹¤.

    3. JWT í† í°ì˜ ìœ íš¨ê¸°ê°„ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    4. ì•”í˜¸í™”í•  SECRET KEYë¥¼ ì´ìš©í•´ ACCESS TOKENì„ ë°œê¸‰í•©ë‹ˆë‹¤.

    5. ì‚¬ìš©ìëŠ” Access Tokenì„ ë°›ì•„ ì €ì¥í•œ í›„, ì¸ì¦ì´ í•„ìš”í•œ ìš”ì²­ë§ˆë‹¤ í† í°ì„ í—¤ë”ì— ì‹¤ì–´ ë³´ëƒ…ë‹ˆë‹¤.

    6. ì„œë²„ì—ì„œëŠ” í•´ë‹¹ í† í°ì˜ Verify Signatureë¥¼ SECRET KEYë¡œ ë³µí˜¸í™”í•œ í›„, ì¡°ì‘ ì—¬ë¶€, ìœ íš¨ê¸°ê°„ì„ í™•ì¸í•©ë‹ˆë‹¤.

   7. ê²€ì¦ì´ ì™„ë£Œëœë‹¤ë©´, Payloadë¥¼ ë””ì½”ë”©í•˜ì—¬ ì‚¬ìš©ìì˜ IDì— ë§ëŠ” ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

   8. í† í°ì˜ ê¸°ë³¸ êµ¬ì¡° JWTì˜ ê¸°ë³¸ êµ¬ì¡° Header . Payload . Signature JWTëŠ” í—¤ë”(header), í˜ì´ë¡œë“œ(payload), ì„œëª…(signature) ì„¸ ê°€ì§€ë¡œ ë‚˜ëˆ ì ¸ ìˆìŠµë‹ˆë‹¤

 -JWT ì¥ì 
  - JWT ì˜ ì£¼ìš”í•œ ì´ì ì€ ì‚¬ìš©ì ì¸ì¦ì— í•„ìš”í•œ ëª¨ë“  ì •ë³´ëŠ” í† í° ìì²´ì— í¬í•¨í•˜ê¸° ë•Œë¬¸ì— ë³„ë„ì˜ ì¸ì¦ ì €ì¥ì†Œê°€ í•„ìš”ì—†ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

  - ë¶„ì‚° ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ í™˜ê²½ì—ì„œ ì¤‘ì•™ ì§‘ì¤‘ì‹ ì¸ì¦ ì„œë²„ì™€ ë°ì´í„°ë² ì´ìŠ¤ì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ” ì‰¬ìš´ ì¸ì¦ ë° ì¸ê°€ ë°©ë²•ì„ ì œê³µí•©ë‹ˆë‹¤.

  - ê°œë³„ ë§ˆì´í¬ë¡œ ì„œë¹„ìŠ¤ì—ëŠ” í† í° ê²€ì¦ê³¼ ê²€ì¦ì— í•„ìš”í•œ ë¹„ë°€ í‚¤ë¥¼ ì²˜ë¦¬í•˜ê¸°ìœ„í•œ ë¯¸ë“¤ì›¨ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤. ê²€ì¦ì€ ì„œëª… ë° í´ë ˆì„ê³¼ ê°™ì€ ëª‡ ê°€ì§€ ë§¤ê°œ ë³€ìˆ˜ë¥¼ ê²€ì‚¬í•˜ëŠ” ê²ƒê³¼ í† í°ì´ ë§Œë£Œë˜ëŠ” ê²½ìš°ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. 

 - JWT ë‹¨ì 

   - í† í°ì€ í´ë¼ì´ì–¸íŠ¸ì— ì €ì¥ë˜ì–´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°ì‘í•˜ë”ë¼ë„ í† í°ì— ì§ì ‘ ì ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

   - ë” ë§ì€ í•„ë“œê°€ ì¶”ê°€ë˜ë©´ í† í°ì´ ì»¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¹„ìƒíƒœ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ í† í°ì€ ê±°ì˜ ëª¨ë“  ìš”ì²­ì— ëŒ€í•´ ì „ì†¡ë˜ë¯€ë¡œ ë°ì´í„° íŠ¸ë˜í”½ í¬ê¸°ì— ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

   - ì´ë¯¸ ë°œê¸‰ëœ JWTì— ëŒ€í•´ì„œëŠ” ëŒì´í‚¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„¸ì…˜/ì¿ í‚¤ì˜ ê²½ìš° ë§Œì¼ ì¿ í‚¤ê°€ ì•…ì˜ì ìœ¼ë¡œ ì´ìš©ëœë‹¤ë©´, í•´ë‹¹í•˜ëŠ” ì„¸ì…˜ì„ ì§€ì›Œë²„ë¦¬ë©´ ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ JWTëŠ” í•œ ë²ˆ ë°œê¸‰ë˜ë©´ ìœ íš¨ê¸°ê°„ì´ ì™„ë£Œë  ë•Œ ê¹Œì§€ëŠ” ê³„ì† ì‚¬ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì•…ì˜ì ì¸ ì‚¬ìš©ìëŠ” ìœ íš¨ê¸°ê°„ì´ ì§€ë‚˜ê¸° ì „ê¹Œì§€ ì‹ ë‚˜ê²Œ ì •ë³´ë“¤ì„ í„¸ì–´ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. -> í•´ê²°ì±… ê¸°ì¡´ì˜ Access Tokenì˜ ìœ íš¨ê¸°ê°„ì„ ì§§ê²Œ í•˜ê³  Refresh Tokenì´ë¼ëŠ” ìƒˆë¡œìš´ í† í°ì„ ë°œê¸‰í•©ë‹ˆë‹¤. ê·¸ë ‡ê²Œ ë˜ë©´ Access Tokenì„ íƒˆì·¨ë‹¹í•´ë„ ìƒëŒ€ì ìœ¼ë¡œ í”¼í•´ë¥¼ ì¤„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ë‹¤ìŒ í¬ìŠ¤íŒ…ì— ë‚˜ì˜¬ Oauth2ì— ë” ìì„¸íˆ ë‹¤ë£¨ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

   - Payload ì •ë³´ê°€ ì œí•œì ì…ë‹ˆë‹¤. ìœ„ì—ì„œ ì–¸ê¸‰í–ˆë‹¤ì‹œí”¼ PayloadëŠ” ë”°ë¡œ ì•”í˜¸í™”ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ë””ì½”ë”©í•˜ë©´ ëˆ„êµ¬ë‚˜ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì„¸ì…˜/ì¿ í‚¤ ë°©ì‹ì—ì„œëŠ” ìœ ì €ì˜ ì •ë³´ê°€ ì „ë¶€ ì„œë²„ì˜ ì €ì¥ì†Œì— ì•ˆì „í•˜ê²Œ ë³´ê´€ë©ë‹ˆë‹¤) ë”°ë¼ì„œ ìœ ì €ì˜ ì¤‘ìš”í•œ ì •ë³´ë“¤ì€ Payloadì— ë„£ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

   - JWTì˜ ê¸¸ì´ì…ë‹ˆë‹¤. ì„¸ì…˜/ì¿ í‚¤ ë°©ì‹ì— ë¹„í•´ JWTì˜ ê¸¸ì´ëŠ” ê¹ë‹ˆë‹¤. ë”°ë¼ì„œ ì¸ì¦ì´ í•„ìš”í•œ ìš”ì²­ì´ ë§ì•„ì§ˆ ìˆ˜ë¡ ì„œë²„ì˜ ìì›ë‚­ë¹„ê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.


 - ë¡œê·¸ì¸ ì‹œë„ì‹œ Token ë³´ë‚´ëŠ” ì½”ë“œ

    ``` js
    const userInfo = await Users.findOne({
    attributes: { exclude: ["password"] }, // excludeë¥¼ ì´ìš©í•˜ë©´ ì œì™¸ê°€ëŠ¥.
    where: { userId: req.body.userId, password: req.body.password },
    });
    if(!userInfo){
    res.send({data: null, message: "not authorized"})
    // dbì— ìœ ì € ì •ë³´ê°€ ì—†ë‹¤ë©´ dataê°’ì„ nullë¡œ ë³´ë‚´ì¤€ë‹¤
    }else {
      const accessToken = jwt.sign(
      userInfo.dataValues,
      process.env.ACCESS_SECRET,
      {
        expiresIn:2000,
      }
    )
    // ìˆë‹¤ë©´ ì—‘ì„¸ìŠ¤í† í°ì„ ìƒì„±í•´ ìœ ì € ì •ë³´ì™€ ì•”í˜¸ ê·¸ë¦¬ê³  ìœ íš¨ê¸°ê°„ì„ ì •í•´ ë³´ë‚´ì¤€ë‹¤ 
    const refreshToken = jwt.sign(
      userInfo.dataValues,
      process.env.REFRESH_SECRET,
      {
        expiresIn:10000,
      }
    )
    //ë¦¬í”„ë ˆì‹œ í† í°ì„ ìƒì„±í•´ refresh ì•”í˜¸ì™€ ìœ íš¨ê¸°ê°„ì„ ì •í•´ ë³´ë‚´ì¤€ë‹¤
    const options = {
      sameSite: 'none',
      httpOnly: true,
      secure: true,
    }
    // ì¿ í‚¤ì˜ ì˜µì…˜ì„ ì •í•´ì¤€ë‹¤
    res.cookie("refreshToken", refreshToken, options)
    res.send({data : {accessToken: accessToken}, message: "ok"})
    }
   ```
 - accessTokenì´ Authorization headerì—ì„œ ë§Œë“¤ì–´ì§„ í† í°ì¸ì§€ë¥¼ í™•ì¸ í•˜ê³  ê·¸ì— ë§ëŠ” ì‘ë‹µì„ ë³´ë‚´ëŠ” ë²• 

 ```js
  const authorization = await req.headers.authorization
 if(!authorization){
    res.send({data: null, message: "invalid access token"})
    // authorizationì—ì„œ ìƒì„±í•œ í† í°ì´ ì•„ë‹ˆë¼ë©´ ë°ì´í„°ë¥¼ ë³´ë‚´ì§€ ì•ŠëŠ”ë‹¤ 
  }else{
    const token = authorization.split(' ')[1];
    const data = jwt.verify(token, process.env.ACCESS_SECRET);

    const userInfo = await Users.findOne({
      attributes: { exclude: ["password"] }, // excludeë¥¼ ì´ìš©í•˜ë©´ ì œì™¸ê°€ëŠ¥.
      where: { userId: data.userId, email: data.email },
    });
    //ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ëŠ” ê²ƒ . 


    res.send({data: { userInfo: userInfo.dataValues }, message: "ok"})
    ì´ë ‡ê²Œ í† í°ì´ ìœ íš¨í™˜ì§€ í™•ì¸í•˜ë©´ ìœ ì €ì— ëŒ€í•œ ì •ë³´ë¥¼ ë³´ë‚¸ë‹¤ .
 ```

 authorizationì„ console.log()ë¡œ ì°ì–´ë³´ë©´ 
 ```
 Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcklkIjoia2ltY29kaW5nIiwiZW1haWwiOiJraW1jb2RpbmdAY29kZXN0YXRlcy5jb20iLCJjcmVhdGVkQXQiOiIyMDIwLTExLTE4VDEwOjAwOjAwLjAwMFoiLCJ1cGRhdGVkQXQiOiIyMDIwLTExLTE4VDEwOjAwOjAwLjAwMFoiLCJpYXQiOjE2MzEwMTYxNjR9.rNo0EKnLM31dXdHfrYVxZMzl3ymANKH5GAzscwgIkUE
Executing (default): SELECT `id`, `userId`, `email`, `createdAt`, `updatedAt` FROM `Users` AS `Users` WHERE `Users`.`userId` = 'kimcoding' AND `Users`.`email` = 'kimcoding@codestates.com' LIMIT 1;
```
ì´ë ‡ê²Œ í•´ì‹±ëœ ê°’ì´ ë‚˜ì˜¤ëŠ”ë° 
```js 
const token = authorization.split(' ')[1];
```
í† í°ì—ì„œ ì´ë ‡ê²Œ split ë©”ì†Œë“œë¡œ ì§€ì • í•´ì¤€ê²ƒì€ 

console.log(token ) ì„ í†µí•´ í™•ì¸ í•´ ë³¼ ìˆ˜ ìˆë‹¤ 

```
Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcklkIjoia2ltY29kaW5nIiwiZW1haWwiOiJraW1jb2RpbmdAY29kZXN0YXRlcy5jb20iLCJjcmVhdGVkQXQiOiIyMDIwLTExLTE4VDEwOjAwOjAwLjAwMFoiLCJ1cGRhdGVkQXQiOiIyMDIwLTExLTE4VDEwOjAwOjAwLjAwMFoiLCJpYXQiOjE2MzEwMTYxNjR9.rNo0EKnLM31dXdHfrYVxZMzl3ymANKH5GAzscwgIkUE
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcklkIjoia2ltY29kaW5nIiwiZW1haWwiOiJraW1jb2RpbmdAY29kZXN0YXRlcy5jb20iLCJjcmVhdGVkQXQiOiIyMDIwLTExLTE4VDEwOjAwOjAwLjAwMFoiLCJ1cGRhdGVkQXQiOiIyMDIwLTExLTE4VDEwOjAwOjAwLjAwMFoiLCJpYXQiOjE2MzEwMTYxNjR9.rNo0EKnLM31dXdHfrYVxZMzl3ymANKH5GAzscwgIkUE
```
ì´ë ‡ê²Œ ë‚˜ì˜¤ëŠ”ë° ì´ê²ƒì€ í† í°ì˜ í•´ì‹±ëœ ê°’ë§Œì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ì„œ ì´ë‹¤ .

- ìš”ì²­ì— ë‹´ê¸´ refresh tokenì´ ìœ íš¨í•˜ë‹¤ë©´   ìƒˆë¡œìš´ access tokenì„ ë°œê¸‰í•´ì¤Œê³¼ ë™ì‹œì— ìœ ì €ê°€ ìš”ì²­í•œ ì •ë³´ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 ìš”ì²­ì— ë‹´ê¸´ refresh tokenì´ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜, ì¡°ì‘ëœ í† í°ì¼ ê²½ìš° ê°ê° ë‹¤ë¥¸ ì‘ë‹µì„ ë°˜í™˜í•©ë‹ˆë‹¤


```js 
const token = req.cookies.refreshToken
 //cookieì— ë‹´ê²¨ìˆëŠ” refresh í† í°ì„ ê°€ì ¸ì˜´
  if(!token){
    return res.send({message: 'refresh token not provided', data: null})
    //í† í°ì´ ì—†ì„ ê²½ìš°ì— ë°ì´í„°ë¥¼ ë³´ë‚´ì§€ ì•ŠìŒ
  }else if(token === 'invalidtoken'){
    res.send({data:null, message: "invalid refresh token, please log in again"})
    //í† í°ì´ ìˆì§€ë§Œ ìœ íš¨ í•˜ì§€ ì•Šì€ í† í°ì¼ ê²½ìš° ë°ì´í„°ë¥¼ ë³´ë‚´ì§€ ì•ŠìŒ
  }else{
    const verify = jwt.verify(token, process.env.REFRESH_SECRET);
    const userInfo = await Users.findOne({
      attributes: { exclude: ["password"] }, // excludeë¥¼ ì´ìš©í•˜ë©´ ì œì™¸ê°€ëŠ¥.
      where: { userId: verify.userId, email: verify.email },
    });
    // í† í°ì´ ìˆê³  ìœ íš¨ í•˜ë‹¤ë©´ í† í°ì— ë‹´ê¸´ userì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê³ 

    const accessToken = jwt.sign(
      userInfo.dataValues,
      process.env.ACCESS_SECRET,
      {
        expiresIn: 2000,
      }
    );
    //ìƒˆë¡œìš´ accessTokenì„ ë°œê¸‰í•˜ê³ 
    
    res.send({data:{accessToken: accessToken, userInfo: userInfo.dataValues}, message: 'ok'})
    //userInfoì™€ accessTokenì„ ê°™ì´ ë³´ëƒ„
```